# 图片占位符工具使用说明

## 概述

项目中已集成图片占位符工具，用于统一处理图片加载失败的情况。当图片加载失败时，会自动替换为 Picsum Photos 占位图或灰色占位图。

## 功能特性

✅ **自动错误处理** - 图片加载失败时自动替换为占位图  
✅ **多种占位图类型** - 支持 Picsum Photos 和纯色占位图  
✅ **懒加载支持** - 内置图片懒加载功能  
✅ **固定占位图** - 同一个失效链接总是显示相同的占位图  
✅ **Vue 指令** - 简单易用的 Vue 指令  
✅ **工具函数** - 提供丰富的工具函数

## 使用方法

### 1. Vue 指令方式（推荐）

#### v-img-fallback - 图片错误处理

**基础用法**：
```vue
<!-- 默认使用 Picsum Photos 占位图 -->
<img v-img-fallback src="https://example.com/image.jpg" />
```

**指定占位图类型**：
```vue
<!-- 使用 Picsum Photos -->
<img v-img-fallback:picsum src="..." />

<!-- 使用灰色占位图 -->
<img v-img-fallback:gray src="..." />
```

**自定义配置**：
```vue
<img 
  v-img-fallback="{ 
    type: 'picsum',
    width: 400, 
    height: 300 
  }" 
  src="..." 
/>

<img 
  v-img-fallback="{ 
    type: 'gray',
    text: '图片加载失败',
    width: 400,
    height: 300
  }" 
  src="..." 
/>
```

#### v-lazy-img - 图片懒加载 + 错误处理

**基础用法**：
```vue
<!-- 图片懒加载，失败时显示 Picsum Photos 占位图 -->
<img v-lazy-img="imageUrl" />
```

**自定义配置**：
```vue
<img 
  v-lazy-img="{ 
    src: imageUrl,
    placeholder: placeholderUrl,
    fallbackType: 'picsum'
  }" 
/>
```

### 2. 工具函数方式

#### 获取占位图 URL

```typescript
import { getPlaceholderImage, getGrayPlaceholder } from '@/utils/image'

// Picsum Photos 占位图
const picsum = getPlaceholderImage(400, 300)
// https://picsum.photos/400/300

// 带随机种子（固定图片）
const picsumFixed = getPlaceholderImage(400, 300, 'my-seed')
// https://picsum.photos/400/300?random=my-seed

// 灰色占位图
const gray = getGrayPlaceholder(400, 300, '图片加载失败')
// data:image/svg+xml;base64,...
```

#### 手动添加错误处理

```typescript
import { addImageErrorHandler, addImageErrorHandlers } from '@/utils/image'

// 为单个图片添加错误处理
const img = document.querySelector('img')
addImageErrorHandler(img, 'picsum')

// 批量为图片添加错误处理
addImageErrorHandlers('img', 'picsum')
```

#### 检查图片 URL

```typescript
import { checkImageUrl, getImageSize } from '@/utils/image'

// 检查图片是否有效
const isValid = await checkImageUrl('https://example.com/image.jpg')

// 获取图片尺寸
const { width, height } = await getImageSize('https://example.com/image.jpg')
```

### 3. 在组件中使用

```vue
<template>
  <div class="product-list">
    <!-- 方式1: 使用 v-img-fallback 指令 -->
    <div v-for="product in products" :key="product.id" class="product-card">
      <img 
        v-img-fallback 
        :src="product.image" 
        :alt="product.name"
        class="product-image"
      />
      <h3>{{ product.name }}</h3>
    </div>

    <!-- 方式2: 使用 v-lazy-img 指令（懒加载） -->
    <div v-for="product in products" :key="product.id" class="product-card">
      <img 
        v-lazy-img="product.image"
        :alt="product.name"
        class="product-image"
      />
      <h3>{{ product.name }}</h3>
    </div>

    <!-- 方式3: 使用工具函数 -->
    <div v-for="product in products" :key="product.id" class="product-card">
      <img 
        :src="product.image || getPlaceholder(product.id)"
        :alt="product.name"
        class="product-image"
        @error="handleImageError"
      />
      <h3>{{ product.name }}</h3>
    </div>
  </div>
</template>

<script setup lang="ts">
import { getPlaceholderImage, handleImageError } from '@/utils/image'

const products = ref([...])

const getPlaceholder = (id: number) => {
  return getPlaceholderImage(400, 300, id)
}
</script>
```

## API 文档

### 工具函数

#### `getPlaceholderImage(width, height, seed?)`

获取 Picsum Photos 占位图 URL

**参数**：
- `width: number` - 图片宽度，默认 400
- `height: number` - 图片高度，默认 300
- `seed?: string | number` - 随机种子，用于固定图片（可选）

**返回**：`string` - Picsum Photos 图片 URL

**示例**：
```typescript
getPlaceholderImage(400, 300)
// https://picsum.photos/400/300

getPlaceholderImage(400, 300, 'product-123')
// https://picsum.photos/400/300?random=product-123
```

#### `getGrayPlaceholder(width, height, text?, bgColor?, textColor?)`

获取灰色占位图（纯色背景）

**参数**：
- `width: number` - 图片宽度，默认 400
- `height: number` - 图片高度，默认 300
- `text?: string` - 占位文字（可选）
- `bgColor?: string` - 背景色，默认 #f0f0f0
- `textColor?: string` - 文字颜色，默认 #999999

**返回**：`string` - Data URL 格式的占位图

**示例**：
```typescript
getGrayPlaceholder(400, 300, '图片加载失败')
// data:image/svg+xml;base64,...
```

#### `handleImageError(event, fallbackType?)`

图片加载错误处理函数

**参数**：
- `event: Event` - 图片加载错误事件
- `fallbackType?: 'picsum' | 'gray'` - 降级类型，默认 'picsum'

**示例**：
```vue
<img src="..." @error="(e) => handleImageError(e, 'picsum')" />
```

#### `addImageErrorHandler(img, fallbackType?)`

为图片元素添加错误处理

**参数**：
- `img: HTMLImageElement` - 图片元素
- `fallbackType?: 'picsum' | 'gray'` - 降级类型，默认 'picsum'

#### `addImageErrorHandlers(selector?, fallbackType?)`

批量为图片元素添加错误处理

**参数**：
- `selector?: string` - CSS 选择器，默认 'img'
- `fallbackType?: 'picsum' | 'gray'` - 降级类型，默认 'picsum'

**示例**：
```typescript
// 为所有图片添加错误处理
addImageErrorHandlers()

// 为特定类的图片添加错误处理
addImageErrorHandlers('.product-image', 'picsum')
```

#### `checkImageUrl(url)`

检查图片 URL 是否有效

**参数**：
- `url: string` - 图片 URL

**返回**：`Promise<boolean>`

**示例**：
```typescript
const isValid = await checkImageUrl('https://example.com/image.jpg')
if (!isValid) {
  console.log('图片无效')
}
```

#### `getImageSize(url)`

获取图片实际尺寸

**参数**：
- `url: string` - 图片 URL

**返回**：`Promise<{width: number, height: number}>`

**示例**：
```typescript
const { width, height } = await getImageSize('https://example.com/image.jpg')
console.log(`图片尺寸: ${width}x${height}`)
```

### Vue 指令

#### `v-img-fallback`

图片错误处理指令

**修饰符**：
- `:picsum` - 使用 Picsum Photos 占位图
- `:gray` - 使用灰色占位图

**值**：
```typescript
{
  type?: 'picsum' | 'gray',
  width?: number,
  height?: number,
  text?: string  // 仅 gray 类型有效
}
```

#### `v-lazy-img`

图片懒加载指令

**值**：
```typescript
string | {
  src: string,
  placeholder?: string,
  fallbackType?: 'picsum' | 'gray'
}
```

## 最佳实践

### 1. 为所有商品图片添加错误处理

```vue
<template>
  <div class="product-grid">
    <div v-for="product in products" :key="product.id">
      <img 
        v-img-fallback 
        :src="product.image" 
        :alt="product.name"
      />
    </div>
  </div>
</template>
```

### 2. 使用懒加载优化性能

```vue
<template>
  <div class="long-list">
    <div v-for="item in items" :key="item.id">
      <img 
        v-lazy-img="item.image"
        :alt="item.title"
      />
    </div>
  </div>
</template>
```

### 3. 固定占位图（使用 ID 作为 seed）

```vue
<template>
  <img 
    v-img-fallback="{ type: 'picsum', width: 400, height: 300 }"
    :src="product.image || getPlaceholder(product.id)"
  />
</template>

<script setup lang="ts">
import { getPlaceholderImage } from '@/utils/image'

const getPlaceholder = (id: number) => {
  return getPlaceholderImage(400, 300, id)
}
</script>
```

### 4. 在 onMounted 中批量处理

```vue
<script setup lang="ts">
import { onMounted } from 'vue'
import { addImageErrorHandlers } from '@/utils/image'

onMounted(() => {
  // 为所有产品图片添加错误处理
  addImageErrorHandlers('.product-image', 'picsum')
})
</script>
```

## 注意事项

1. **避免无限循环**：工具函数内部已处理，同一个图片只会替换一次
2. **性能考虑**：大量图片建议使用懒加载（`v-lazy-img`）
3. **国内访问**：Picsum Photos 在国内访问速度可能较慢，可考虑使用灰色占位图
4. **固定占位图**：使用 seed 参数可以确保同一个失效链接总是显示相同的占位图
5. **尺寸匹配**：占位图尺寸会自动匹配原图片的尺寸

## 示例效果

### Picsum Photos 占位图
- 显示真实的随机图片
- 视觉效果更好
- 适合对外展示

### 灰色占位图
- 纯色背景 + 文字提示
- 加载速度快
- 适合内部使用或网络环境差的情况

## 文件结构

```
src/
├── utils/
│   └── image.ts           # 图片工具函数
├── directives/
│   └── image.ts           # Vue 图片指令
└── main.ts                # 注册全局指令
```

## 更新日志

### 2025-10-23
- ✅ 创建图片工具函数 (`src/utils/image.ts`)
- ✅ 创建 Vue 图片指令 (`src/directives/image.ts`)
- ✅ 注册全局指令 (`v-img-fallback`, `v-lazy-img`)
- ✅ 支持 Picsum Photos 和灰色占位图
- ✅ 支持图片懒加载
- ✅ 支持固定占位图（使用 seed）

